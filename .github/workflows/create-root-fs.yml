name: Create Arch root filesystem

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  KIOSK_USER: kiosk
  OUTPUT_TARBALL: arch_kiosk_rootfs.tar.zst
  ROOTFS_DIR: ${{ github.workspace }}/arch_rootfs

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ── 1. Install host packages ────────────────────────────────────────────
      - name: Install required packages
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
              zstd proot

          # Docker is pre-installed on ubuntu-latest; just verify it's running.
          docker info &>/dev/null || sudo service docker start

      # ── 2. Create Arch rootfs ───────────────────────────────────────────────
      - name: Create Arch root filesystem
        run: |
          set -euo pipefail
          docker pull --quiet archlinux:latest
          CONTAINER_ID=$(docker create archlinux:latest)
          mkdir -p "$ROOTFS_DIR"
          docker export "$CONTAINER_ID" | tar -x -C "$ROOTFS_DIR"
          docker rm "$CONTAINER_ID"

      # ── 3. Bootstrap pacman ─────────────────────────────────────────────────
      - name: Bootstrap pacman & update system
        run: |
          set -euo pipefail
          sudo cp /etc/resolv.conf "$ROOTFS_DIR/etc/resolv.conf"

          # Mount pseudo-filesystems for chroot
          for fs in proc sys dev dev/pts; do
            sudo mountpoint -q "$ROOTFS_DIR/$fs" 2>/dev/null || \
              sudo mount --bind "/$fs" "$ROOTFS_DIR/$fs"
          done

          sudo chroot "$ROOTFS_DIR" /bin/bash -c "
            set -e
            pacman-key --init
            pacman-key --populate archlinux
            echo 'Server = https://geo.mirror.pkgbuild.com/\$repo/os/\$arch' \
              > /etc/pacman.d/mirrorlist
            pacman -Sy --noconfirm archlinux-keyring
            pacman -Su --noconfirm
          "

      # ── 4. Create kiosk user with autologin ─────────────────────────────────
      - name: Create autologin user
        run: |
          set -euo pipefail
          sudo chroot "$ROOTFS_DIR" /bin/bash -c "
            set -e
            useradd -m -s /bin/bash '${KIOSK_USER}' 2>/dev/null || true
            passwd -d '${KIOSK_USER}'

            mkdir -p /etc/systemd/system/getty@tty1.service.d
            cat > /etc/systemd/system/getty@tty1.service.d/autologin.conf <<'UNIT'
          [Service]
          ExecStart=
          ExecStart=-/sbin/agetty --autologin ${KIOSK_USER} --noclear %I \$TERM
          UNIT
            systemctl enable getty@tty1.service 2>/dev/null || true
          "

      # ── 5. Install Chromium & X11 ───────────────────────────────────────────
      - name: Install Chromium and X11
        run: |
          set -euo pipefail
          sudo chroot "$ROOTFS_DIR" /bin/bash -c "
            set -e
            pacman -S --noconfirm --needed \
              chromium \
              xorg-server \
              xorg-xinit \
              xf86-video-vesa \
              ttf-liberation \
              noto-fonts \
              iputils \
              sudo
          "

      # ── 6. Write kiosk startup scripts ─────────────────────────────────────
      - name: Create kiosk startup scripts
        run: |
          set -euo pipefail
          HOME_DIR="$ROOTFS_DIR/home/$KIOSK_USER"

          # .xinitrc – starts Chromium directly, no WM
          sudo tee "$HOME_DIR/.xinitrc" > /dev/null <<'XINITRC'
          #!/bin/bash
          URL_FILE="$HOME/url.txt"
          URL="about:blank"
          [ -r "$URL_FILE" ] && URL="$(cat "$URL_FILE")"

          xset s off
          xset s noblank
          xset -dpms

          exec chromium \
            --no-sandbox \
            --kiosk \
            --noerrdialogs \
            --disable-infobars \
            --disable-session-crashed-bubble \
            --disable-restore-session-state \
            --disable-background-networking \
            --disable-translate \
            --no-first-run \
            "$URL"
          XINITRC
          sudo chmod +x "$HOME_DIR/.xinitrc"

          # .bash_profile – ping check then startx
          sudo tee "$HOME_DIR/.bash_profile" > /dev/null <<'BASHPROFILE'
          #!/bin/bash
          [ "$(tty)" = "/dev/tty1" ] || return

          echo "[kiosk] Checking internet connectivity..."
          if ! ping -c 3 -W 5 8.8.8.8 &>/dev/null; then
            echo "[kiosk] No internet access – shutting down."
            sudo /sbin/poweroff
            exit 1
          fi

          echo "[kiosk] Internet OK – starting Chromium kiosk..."
          exec startx -- -nolisten tcp &>/tmp/kiosk_x.log
          BASHPROFILE

          # sudoers: allow kiosk to poweroff without password
          sudo tee "$ROOTFS_DIR/etc/sudoers.d/kiosk-poweroff" > /dev/null <<'SUDOERS'
          kiosk ALL=(ALL) NOPASSWD: /sbin/poweroff, /sbin/shutdown
          SUDOERS
          sudo chmod 0440 "$ROOTFS_DIR/etc/sudoers.d/kiosk-poweroff"

          # Placeholder URL
          echo "https://example.com" | sudo tee "$HOME_DIR/url.txt" > /dev/null

          # Fix ownership
          sudo chroot "$ROOTFS_DIR" /bin/bash -c \
            "chown -R '${KIOSK_USER}:${KIOSK_USER}' '/home/${KIOSK_USER}'"

      # ── 7. Unmount and pack ─────────────────────────────────────────────────
      - name: Create compressed tarball
        run: |
          set -euo pipefail

          # Unmount pseudo-filesystems before archiving
          for fs in dev/pts dev sys proc; do
            sudo mountpoint -q "$ROOTFS_DIR/$fs" 2>/dev/null && \
              sudo umount -l "$ROOTFS_DIR/$fs" || true
          done

          sudo tar -C "$ROOTFS_DIR" \
            --use-compress-program="zstd -T0 -19" \
            -cpf "$OUTPUT_TARBALL" \
            .

          echo "Final size: $(du -sh "$OUTPUT_TARBALL" | cut -f1)"

      # ── 8. Upload artifact ──────────────────────────────────────────────────
      - name: Upload rootfs tarball
        uses: actions/upload-artifact@v4
        with:
          name: arch-kiosk-rootfs
          path: ${{ env.OUTPUT_TARBALL }}
          retention-days: 7
          compression-level: 0   # already zstd-compressed; skip re-compression
